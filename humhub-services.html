<script type="text/javascript">
    RED.nodes.registerType('client-credentials',{
        category: 'config',
        defaults: {
            name: {value: ""},
            username: {value: ""},
            password: {value: "", type:"password"},
            bearer_token: {value: ""},
            host: {value: ""},
            authentification: {value: ""},
        },

        oneditprepare: function(){
            console.log('prepare', this);
            
            
            $("#node-config-input-authentification").typedInput({
                
                types: [
                    {
                        value: "authentification",
                        options: [
                            { value: "Login", label: "Login"},
                            { value: "Token", label: "Token"},

                        ]
                    }
                ]
            });

            $("#node-config-input-authentification").change(function () {
                switch ($(this).val()) {
                    case 'Login':
                        
                    
                        $('#row-token').hide();
                        $('#row-username').show();
                        $('#row-password').show();
                        break
                    case 'Token':
                        
                       
                        $('#row-token').show();
                        $('#row-username').hide();
                        $('#row-password').hide();
                        break
                    default:
                        console.log('default')
                }
            })

            
        },
        oneditsave: function() {
            console.log('save', this);
        },
        oneditresize: function() {
            console.log('resize', this);
        },
        label: function() {
            return this.name;
        }
    });
</script>

<script type="text/x-red" data-template-name="client-credentials">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-config-input-host"><i class="fa fa-lock"></i> Host</label>
        <input type="text" id="node-config-input-host">
    </div>

    <div class="form-row">
        <label for="node-config-input-authentification"> Authentification</label>
        <input type="text" id="node-config-input-authentification">
    </div>

    <div class="form-row" id="row-username">
        <label for="node-config-input-username"><i class="fa fa-lock"></i> Username</label>
        <input type="text" id="node-config-input-username">
    </div>
    <div class="form-row" id="row-password">
        <label for="node-config-input-password"><i class="fa fa-lock"></i> Password</label>
        <input type="password" id="node-config-input-password">
    </div>
    <div class="form-row" id="row-token">
        <label for="node-config-input-bearer_token"><i class="fa fa-lock"></i> Bearer Token</label>
        <input type="text" id="node-config-input-bearer_token">
    </div>
    
</script>



<script type="text/javascript">
    RED.nodes.registerType('humhub-services',{
        category: 'function',
        color: '#a6bbcf',
        defaults: {
            
            creds: {type:"client-credentials",required:true},
            contentType:{value:"posts"},
            method: {value:""},
            filters: {
                value:[
                    {
                        filterKey: "id",
                        filterOperator: "===",
                        filterValue: "",
                        filterValueType: "str",
                    }
                ]
            },
            putPayload: {
                value:[
                    {
                        type: "str",
                        value: ""

                    }
                ]
            },
            postPayload: {
                value:[
                    {
                        type: "str",
                        value: ""

                    }
                ]
            },
            idd:{
				value: '',
				required: false,
				validate: RED.validators.typedInput('inputtype')
            },
            iddtype: { value: 'num' },

        },
        inputs: 1,
        outputs: 1,
        icon: "file.svg",
        oneditprepare: function(){
            structGET={
                        posts:["id","Message's length","Likes","Topics"]
            };
            structPOST={
                        posts:[["container id","string"],["message","string"],["scheduled_at","string"],["topics","stringArray"]]
            };
            structPUT={
                        posts:[["message","string"],["scheduled_at","string"],["topics","stringArray"]]
            };    
            

            console.log('prepare', this);
            if(!this.putPayload){this.putPayload=[];}
            if(!this.postPayload){this.postPayload=[];}
            const getKeys = structGET.posts;
            const putKeys = structPUT.posts.map(x=>x[0]);
            const postKeys = structPOST.posts.map(x=>x[0]);


            for(let i=0;i<putKeys.length;i++){
           
                var row = $('<div/>',{style:"display:flex; align-items: baseline; margin-top:8px;"})
                .appendTo($('#node-input-putField'));
                $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                            .text(putKeys[i]+" :")
                            .appendTo(row);
                var putPayloadWidget = $('<input/>',{class:"node-input-putPayload",id:"node-input-putPayload"+i,type:"text",style:"width: 300px;"})
                .appendTo(row).typedInput({types:['msg','flow','global','str']});
                if(!this.putPayload[i]){
                    this.putPayload[i]={value:"payload."+putKeys[i],type:"msg"};
                    putPayloadWidget.typedInput('value',"payload."+putKeys[i]);
                    putPayloadWidget.typedInput('type',"msg");
                }
                else{
                    putPayloadWidget.typedInput('value',this.putPayload[i].value);
                    putPayloadWidget.typedInput('type',this.putPayload[i].type);
                }
            }
 
            for(let i=0;i<postKeys.length;i++){
           
           var row = $('<div/>',{style:"display:flex; align-items: baseline; margin-top:8px;"})
           .appendTo($('#node-input-postField'));
           $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                       .text(postKeys[i]+" :")
                       .appendTo(row);
           var postPayloadWidget = $('<input/>',{class:"node-input-postPayload",id:"node-input-postPayload"+i,type:"text",style:"width: 300px;"})
           .appendTo(row).typedInput({types:['msg','flow','global','str']});
           if(!this.postPayload[i]){
               this.postPayload[i]={value:"payload."+postKeys[i],type:"msg"};
               postPayloadWidget.typedInput('value',"payload."+postKeys[i]);
               postPayloadWidget.typedInput('type',"msg");
           }
           else{
               postPayloadWidget.typedInput('value',this.postPayload[i].value);
               postPayloadWidget.typedInput('type',this.postPayload[i].type);
           }
       }

            $('#node-input-idd').typedInput({
                default: 'num',
                typeField: $("#node-input-iddtype"),
                types: ['flow','global','msg','num']
            });

            $("#node-input-contentType").typedInput({
                types: [
                    {
                        value: "contentType",
                        options: [
                            { value: "Posts", label: "Posts"},

                        ]
                    }
                ]
            });

            $("#node-input-method").typedInput({
                types: [
                    {
                        value: "method",
                        options: [
                            { value: "GET", label: "GET"},
                            { value: "PUT", label: "PUT"},
                            { value: "DELETE", label: "DELETE"},
                            { value: "POST", label: "POST"}
                        ]
                    }
                ]
            });

            $("#node-input-method").change(function () {
                switch ($(this).val()) {
                    case 'GET':
                        console.log('GET')
                    
                        $('#row-idd').hide();
                        $('#row-filter').show();
                        $('#node-input-putField').hide();
                        $('#node-input-postField').hide();

                        break
                    case 'PUT':
                        console.log('PUT');
                       
                        $('#row-idd').show();
                        $('#row-filter').hide();
                        $('#node-input-putField').show();
                        $('#node-input-postField').hide();

                        break
                    case 'DELETE':
                        console.log('DELETE');                       
                        $('#row-filter').hide();
                        $('#node-input-putField').hide();
                        $('#row-idd').show();
                        $('#node-input-postField').hide();
                        break
                    case 'POST':
                        console.log('POST');
                        $('#row-idd').hide();
                        $('#row-filter').hide();
                        $('#node-input-putField').hide();
                        $('#node-input-postField').show();
                        break
                    default:
                        console.log('default')
                }
            })
            
            $('#node-input-filter-container').css('min-height','375px').css('min-width','450px').css('overflow-x','clip').editableList({
                addItem: function(container,i,opt) {
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    let fragment = document.createDocumentFragment();
                    let filterValue="";
                    if(opt.filterValue){filterValue=opt.filterValue;}
                    let filterValueType="str";
                    if(opt.filterValueType){filterValueType=opt.filterValueType;}

                    let filterKey="";
                    if(getKeys.length){filterKey=getKeys[0];}
                    if(opt.filterKey){filterKey=opt.filterKey;}

                    let filterOperator="===";
                    if(opt.filterOperator){filterOperator=opt.filterOperator;}
                   
                   
                    var row1 = $('<div/>',{style:"display:flex; align-items: baseline"}).appendTo(fragment);
                    
                    var row2 = $('<div/>', {style:"display:flex;align-items: baseline ;margin-top:8px;"}).appendTo(fragment);
                    



                    
                    optionsFilter=getKeys.map(x => {return {value: x, label: x};});

                    var filterKeyWidget = $('<select/>',{class:"node-input-filterKey",style:"width:110px; margin-right:10px;"});
                    for (var i=0; i<optionsFilter.length; i++) {
                        filterKeyWidget.append($("<option></option>").val(optionsFilter[i].value).text(optionsFilter[i].label));
                    }
                    filterKeyWidget.val(filterKey);

                    let optionsOperator=[{value:"===",label:"equal"},{value:"!==",label:"not equal"},{value:">",label:"greater than"},{value:"<",label:"lesser than"},{value:">=",label:"greater than or equal"},{value:"<=",label:"lesser than or equal"}];
                    var filterOperatorWidget = $('<select/>',{class:"node-input-filterOperator", style:"width: 300px;"});
                    for (var i=0; i<optionsOperator.length; i++) {
                        filterOperatorWidget.append($("<option></option>").val(optionsOperator[i].value).text(optionsOperator[i].label));
                    }
                    filterOperatorWidget.val(filterOperator);
                   

             
                    var filterValueWidget = $('<input/>',{class:"node-input-filterValue",type:"text",style:"width: 300px;"});
                    
                    
                    

                    console.log("postInit filterValueType = "+filterValueType,this);

                    filterKeyWidget.appendTo(row1);
                    filterOperatorWidget.appendTo(row1);


                    
                    $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(" Valeur :")
                        .appendTo(row2);
                    filterValueWidget.appendTo(row2).typedInput({types:['msg','flow','global','str']});
                    filterValueWidget.typedInput('value',filterValue);
                    filterValueWidget.typedInput('type',filterValueType);
                    filterValueWidget.css('width','300px')
         


                    container[0].appendChild(fragment);



                },
                removable: true,
                sortable: true

            });

            for (var i=0; i<this.filters.length; i++) {
                var filter = this.filters[i];
                $("#node-input-filter-container").editableList('addItem',filter);            

            }
            
        },
        oneditsave: function() {
            console.log('save', this);
            this.filters=[];
      
            var tempFilters=$("#node-input-filter-container").editableList('items');
            for(let i=0;i<tempFilters.length;i++){
                let filterWidget=tempFilters[i];
                let fV=filterWidget.find(".node-input-filterValue").typedInput('value');
                let fK=filterWidget.find(".node-input-filterKey").val();
                let fO=filterWidget.find(".node-input-filterOperator").val();
                let fVT=filterWidget.find(".node-input-filterValue").typedInput('type');
            
                this.filters.push({filterKey: fK,
                                filterOperator: fO,
                                filterValue: fV,
                                filterValueType: fVT});
                
                

            };
            
            this.putPayload=[];
            var tempPutPayload=$("#node-input-putField").find(".node-input-putPayload");
            var sz=tempPutPayload.length;
            for(let i=0;i<sz;i++){
                let temp=$("#node-input-putField").find("#node-input-putPayload"+i);
                this.putPayload.push({value:temp.typedInput('value'),
                type:temp.typedInput('type')});
            }
            
            this.postPayload=[];
            var tempPostPayload=$("#node-input-postField").find(".node-input-postPayload");
            var sz=tempPostPayload.length;
            for(let i=0;i<sz;i++){
                let temp=$("#node-input-postField").find("#node-input-postPayload"+i);
                this.postPayload.push({value:temp.typedInput('value'),
                type:temp.typedInput('type')});
            }
        },
        oneditresize: function() {
            console.log('resize', this);
        },
        label: function() {
            return this.name||"humhub-services";
        }
    });
</script>

<script type="text/x-red" data-template-name="humhub-services">
    <div class="form-row">
        <label for="node-input-creds"><i class="fa fa-tag"></i> Credentials</label>
        <input type="text" id="node-input-creds">
    </div>
    <div class="form-row">
        <label for="node-input-method"> Method</label>
        <input type="text" id="node-input-method">
    </div>
    <div class="form-row">
        <label for="node-input-contentType"> What </label>
        <input type="text" id="node-input-contentType">
    </div>

   

    <div class="form-row" id="row-filter">
        <style>
            ol#node-input-filter-container .red-ui-typedInput-container {
                flex:1;
            }
        </style>
        
        <div class="form-row" style="margin-bottom:0;">
            <label><i class="fa fa-list"></i> <span> Filters</span></label>
        </div>
        <div class="form-row node-input-filter-container-row">
            <ol id="node-input-filter-container" style="overflow-x:clip;">
                
            </ol>
        </div>

        

    </div>

    


    <div class="form-row" id="row-idd">
		<label for="node-input-idd"><i class="fa fa-hashtag"></i> Id</label>
		<input type="text" id="node-input-idd" style="width:70%">
		<input type="hidden" id="node-input-iddtype">
    </div>

    <div class="form-row" id="node-input-putField">
           
    </div>

    <div class="form-row" id="node-input-postField">
       
    </div>
    




</script>

<script type="text/html" data-help-name="humhub-services">
    <p>A simple node that converts the message payloads into all humhub-services</p>
</script>